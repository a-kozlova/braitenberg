<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <link rel="stylesheet" type="text/css" href="assets/css/font-awesome.min.css" media="screen" />


    <link href="https://fonts.googleapis.com/css?family=Roboto:400,500|Open+Sans" rel="stylesheet">
    <!-- <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.css"> -->
    <link rel="stylesheet" href="bootstrap-4.3.1-dist/css/bootstrap.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons" />
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
    <!-- <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script> -->
    <script src="bootstrap-4.3.1-dist/js/bootstrap.js"></script>
    <!--DRAGGABLE-->
    

    <style>
        html,
        body {
            margin: 0 !important;
            padding: 0 !important;
            overflow: hidden;
        }
    </style>
</head>
  <body>
    
    <!--SETTINGS-->
    <div id="myEntitySettings" class="sidenav">
		    <div class="row">
			    <div class="col-10 left">
				    Settings
			    </div>
			    <div class="col-2 right">
				    <button class="closebtn" onclick="closeSettings()">&times;</button>
			    </div>
		    </div>
		    <div id="settingsMenu">
                <div class="nav nav-tabs nav-fil" id="myTabs" role="tablist">
                    <a class="nav-item nav-link active col-4" data-toggle="tab" href="#motor" role="tab" aria-controls="nav-home" aria-selected="true">Motor</a>
                    <a class="nav-item nav-link col-4" data-toggle="tab" href="#sensor" role="tab" aria-controls="nav-home" aria-selected="false">Sensor</a>
                    <a class="nav-item nav-link col-4" data-toggle="tab" href="#body" role="tab" aria-controls="nav-home" aria-selected="false">Body</a>
                    <a class="nav-item nav-link col-6" data-toggle="tab" href="#emission" role="tab" aria-controls="nav-home" aria-selected="false">Emission</a>
                    <a class="nav-item nav-link col-6" data-toggle="tab" href="#connection" role="tab" aria-controls="nav-home" aria-selected="false">Connection</a>
                </div>

                <div class="tab-content" id="nav-tabContent">
                    <div role="tabpanel" class="tab-pane active" id="motor">
                        <h4>Position</h4>
                        <div id="drag-drop-basic">
                            <div id="motorContainer" data-role="drag-drop-container" class="col-8" style="border: 1px green dashed">
                                <canvas id="motorCanvas"> </canvas>
                            </div>
                            <div id="addRemoveMotor" data-role="drag-drop-container" class="col-4 ui-widget ui-widget-content">
                                <button id="addMotor" draggable="true">+</button>
                            </div>
                        </div>
                        <h4>Current Speed</h4>
                            <div id="currentSpeed"> </div>
                        <h4>Min Speed</h4>
                            <div id="minSpeed"> </div>
                        <h4>Max Speed</h4>
                            <div id="maxSpeed"> </div>
                    </div>

                    <div role="tabpanel" class="tab-pane fade" id="sensor">
                        <h4>Position</h4>
                        <h4>Reichweite</h4>
                        <h4>Winkel</h4>
                    </div>

                    <div role="tabpanel" class="tab-pane fade" id="emission">
                        <h4>Type</h4>
                        <div class="custom-control">
                            <input type="radio" id="barrier" name="emission" class="custom-control-input" checked>
                            <label class="custom-control-label" for="barrier">Barrier</label>
                        </div>
                        <div class="custom-control">
                            <input type="radio" id="sour" name="emission" class="custom-control-input">
                            <label class="custom-control-label" for="sour">Source</label>
                        </div>
                    </div>

                    <div role="tabpanel" class="tab-pane fade" id="body">
                        <h4>Form</h4>
                        <div id="shape">
                            <div class="custom-control">
                                <input type="radio" id="rectangle" name="form" class="custom-control-input" checked>
                                <label class="custom-control-label" for="rectangle">Rectangle</label>
                            </div>
                            <div class="custom-control">
                                <input type="radio" id="circle" name="form" class="custom-control-input">
                                <label class="custom-control-label" for="circle">Circle</label>
                            </div>
                        </div>

                        <h4>Breite</h4>
                        <h4>Höhe</h4>
                        <h4>Farbe</h4>
                        <div class="custom-control custom-radio">
                            <input type="radio" id="grey" name="farbe" class="custom-control-input" checked>
                            <label class="custom-control-label" for="grey">Grey</label>
                        </div>
                        <div class="custom-control custom-radio">
                            <input type="radio" id="red" name="farbe" class="custom-control-input">
                            <label class="custom-control-label" for="red">Red</label>
                        </div>
                        <div class="custom-control custom-radio">
                            <input type="radio" id="green" name="farbe" class="custom-control-input">
                            <label class="custom-control-label" for="green">Green</label>
                        </div>
                        <div class="custom-control custom-radio">
                            <input type="radio" id="blue" name="farbe" class="custom-control-input">
                            <label class="custom-control-label" for="blue">Blue</label>
                        </div>
                    </div>

                    <div role="tabpanel" class="tab-pane fade" id="connection">Connection</div>

                </div>
            </div>
    </div>
  
   
   <!--CREATE ENTITY-->
   <div id="createEntityMenu" style="float: right; margin-right: 60px;">
        <span style="font-size:30px;cursor:pointer; position: absolute" onclick="openNav()" >&#9776;</span>
   </div>

    <div id="mySidenav" class="sidenav">
		<div class="container create-entity">
		  <div class="row">
			<div class="col-10 left">
				Create entity
			</div>
			<div class="col-2 right">
				<button class="closebtn" onclick="closeNav()">&times;</button>
			</div>
		  </div>
		</div>       
		
		<div class="accordion" id="accordionExample">
            <div class="card">
                <button id="blank" class="prefab-btn"><img src="assets/prefabs/blank.png" alt="blank"></button>
            </div>

            <div class="card">
                <button type="button" class="my-btn collapsed" data-toggle="collapse" data-target="#collapseOne">Source</button>
                <div id="collapseOne" class="collapse show" aria-labelledby="headingOne" data-parent="#accordionExample">
                    <div class="card-body">
                        <button id="source" class="prefab-btn"><img src="assets/prefabs/source.png" alt="source"></button>
                    </div>
                </div>
            </div>
            <div class="card">
                <button type="button" class="my-btn collapsed" data-toggle="collapse" data-target="#collapseTwo">Vehicle</button>
                <div id="collapseTwo" class="collapse show" aria-labelledby="headingTwo" data-parent="#accordionExample">
                    <div class="card-body">
                        <button id="prefab2a" class="prefab-btn"><img src="assets/prefabs/2a.png" alt="vehicle-2a"></button>
					    <button id="prefab2b" class="prefab-btn"><img src="assets/prefabs/2b.png" alt="vehicle-2b"></button>
					    <button id="prefab3a" class="prefab-btn"><img src="assets/prefabs/3a.png" alt="vehicle-3a"></button>
					    <button id="prefab3b" class="prefab-btn"><img src="assets/prefabs/3b.png" alt="vehicle-3b"></button>
		
                    </div>
                </div>
            </div>

            <div class="card">
                <button type="button" class="my-btn collapsed" data-toggle="collapse" data-target="#collapseThree">Barrier</button>
                <div id="collapseThree" class="collapse show" aria-labelledby="headingThree" data-parent="#accordionExample">
                    <div class="card-body">
					    <button id="testbutton">Create A Barrier</button> 
                    </div>
                </div>
            </div>
        </div>
	</div>   

      <!--GAME-->
      <div id="phaser">  </div>
       
    

    <script>
        var entity = null;
        var changed = [];

        function openSettings(event) {
			closeNav();
            document.getElementById("myEntitySettings").style.width = "256px";
			document.getElementById("createEntityMenu").style.marginRight = "306px";
            entity = event.detail;                  // die aufgerufene Entität
            //console.log(entity);

            drawMotors(entity.components);
            drawSliders(entity.components);

            document.addEventListener("entitySelected", switchEntity);            
        }

        $('#addMotor').draggable({
            start: function () {
                console.log("start");
            },
            drag: function () {
                console.log("drag");
            },
            stop: function () {
                console.log("stop");
            }
        });

        function switchEntity(event) {
            closeSettings();
            console.log("switch", entity);
            openSettings(event);
        }
              
        document.addEventListener("entitySelected", openSettings);

        function drawSliders(components) {
            var slider = `<div class="d-flex justify-content-center my-8">
                             <span class="font-weight-bold indigo-text mr-2 mt-1">0</span>
                             <form class="range-field w-25">
                                 <input class="border-0" type="range" min="0" max="100" />
                             </form>
                             <span class="font-weight-bold indigo-text ml-2 mt-1">100</span>
                         </div>`;
            var currentSpeed = document.getElementById("currentSpeed");
            var maxSpeed = document.getElementById("maxSpeed");
            var minSpeed = document.getElementById("minSpeed");
            var sliders = [];
            components.forEach(component => {
                if (component.name == "Motor") {
                    sliders.push(slider);
                }
            });
            
            currentSpeed.innerHTML = sliders;
            maxSpeed.innerHTML = sliders;
            minSpeed.innerHTML = sliders;
        }


        function drawMotors(components) {
            var motors = [];
            var canvas = document.getElementById("motorCanvas"),
                context = canvas.getContext("2d"),
                width = canvas.width = components[1].size.value.width +10,
                height = canvas.height = components[1].size.value.height +10,
                startPoint = { "x": canvas.width / 2, "y": canvas.height / 2 },
                color = ["#00ffff", "#00ff00", "#ff00ff", "#cecece"],
                offset = {},
                isDragging = false,
                dragHandle = null;
            var i = 0;

            components.forEach(component => {
                if (component.name == "Motor") {
                  let motor = {
                    x: startPoint.x + component.position.value.x,
                    y: startPoint.y + component.position.value.y,
                    radius: 5,
                    id: component.id,
                    color: color[i],
                    name: "Motor"
                    };
                  i++;
                  motors.push(motor);
                }
            });

            draw();

            function draw() {
              context.clearRect(0, 0, width, height);
              context.strokeRect(5, 5, width-5, height-5);

              for (var i = 0; i < motors.length; i += 1) {
                context.fillStyle = color[i];
                let motor = motors[i];
                if (isDragging && motor === dragHandle) {
                  context.shadowColor = "black";
                  context.shadowOffsetX = 4;
                  context.shadowOffsetY = 4;
                  context.shadowBlur = 8;
                }

                context.beginPath();
                context.arc(motor.x, motor.y, motor.radius, 0, Math.PI * 2, false);
                context.fill();
                context.stroke();

                context.shadowColor = null;
                context.shadowOffsetX = null;
                context.shadowOffsetY = null;
                context.shadowBlur = null;
              }
            }

            canvas.addEventListener("mousedown", function (event) {
              motors.forEach(function (motor) {
                if (circlePointCollision(event.offsetX, event.offsetY, motor)) {
                  isDragging = true;
                  canvas.addEventListener("mousemove", onMouseMove);
                  canvas.addEventListener("mouseup", onMouseUp);
                  dragHandle = motor;
                  offset.x = event.clientX - motor.x;
                  offset.y = event.clientY - motor.y;
                  draw();
                  
                }
              });

            });

            function onMouseMove(event) {
              dragHandle.x = event.clientX - offset.x;
              dragHandle.y = event.clientY - offset.y;
                draw();
            }

            function onMouseUp(event) {
              canvas.removeEventListener("mousemove", onMouseMove);
              canvas.removeEventListener("mouseup", onMouseUp);
              isDragging = false;
              draw();
              
            }

            

            function distanceXY(x0, y0, x1, y1) {
              var dx = x1 - x0,
                  dy = y1 - y0;
              return Math.sqrt(dx * dx + dy * dy);
            }

            function circlePointCollision(x, y, circle) {
              return distanceXY(x, y, circle.x, circle.y) < circle.radius;
            }

            
            

            //canvas.ondragstart = closeNav;
            
        }

        



        




        function closeSettings() {
            console.log("closeNav");
            document.getElementById("myEntitySettings").style.width = "0";
			document.getElementById("createEntityMenu").style.marginRight = "60px";
            var canvas = document.getElementById("motorCanvas");
            var ctx = canvas.getContext("2d");
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }     

		function openNav() {
			closeSettings();
            document.getElementById("mySidenav").style.width = "256px";		

        }

        function closeNav() {
            document.getElementById("mySidenav").style.width = "0";
        }


    </script>


  </body>
</html>

